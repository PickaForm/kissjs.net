

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> client/core/db/online.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
             
                <a href="index.html">
                    <h1 class="navbar-item">KissJS api documentation</h1>
                </a>
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Namespaces</h3><ul><li><a href="kiss.html">kiss</a></li><li><a href="kiss.acl.html">acl</a></li><li><a href="kiss.ajax.html">ajax</a></li><li><a href="kiss.app.html">app</a></li><li><a href="kiss.context.html">context</a></li><li><a href="kiss.data.html">data</a></li><li><a href="kiss.data.trash.html">trash</a></li><li><a href="kiss.db.html">db</a></li><li><a href="kiss.db.faker.html">faker</a></li><li><a href="kiss.db.memory.html">memory</a></li><li><a href="kiss.db.mongo.html">mongo</a></li><li><a href="kiss.db.offline.html">offline</a></li><li><a href="kiss.db.online.html">online</a></li><li><a href="kiss.directory.html">directory</a></li><li><a href="kiss.formula.html">formula</a></li><li><a href="kiss.language.html">language</a></li><li><a href="kiss.loader.html">loader</a></li><li><a href="kiss.loadingSpinner.html">loadingSpinner</a></li><li><a href="kiss.logger.html">logger</a></li><li><a href="kiss.plugins.html">plugins</a></li><li><a href="kiss.pubsub.html">pubsub</a></li><li><a href="kiss.router.html">router</a></li><li><a href="kiss.screen.html">screen</a></li><li><a href="kiss.selection.html">selection</a></li><li><a href="kiss.serviceWorker.html">serviceWorker</a></li><li><a href="kiss.session.html">session</a></li><li><a href="kiss.theme.html">theme</a></li><li><a href="kiss.tools.html">tools</a></li><li><a href="kiss.ui.html">ui</a></li><li><a href="kiss.undoRedo.html">undoRedo</a></li><li><a href="kiss.ux.html">ux</a></li><li><a href="kiss.views.html">views</a></li><li><a href="kiss.websocket.html">websocket</a></li></ul><h3>Classes</h3><ul><li><a href="kiss.data.Collection.html">Collection</a></li><li><a href="kiss.data.Model.html">Model</a></li><li><a href="kiss.data.RecordFactory-Record.html">Record</a></li><li><a href="kiss.data.Transaction.html">Transaction</a></li><li><a href="kiss.ui.Attachment.html">Attachment</a></li><li><a href="kiss.ui.Block.html">Block</a></li><li><a href="kiss.ui.Button.html">Button</a></li><li><a href="kiss.ui.Calendar.html">Calendar</a></li><li><a href="kiss.ui.Checkbox.html">Checkbox</a></li><li><a href="kiss.ui.Color.html">Color</a></li><li><a href="kiss.ui.ColorPicker.html">ColorPicker</a></li><li><a href="kiss.ui.Component.html">Component</a></li><li><a href="kiss.ui.Container.html">Container</a></li><li><a href="kiss.ui.DataComponent.html">DataComponent</a></li><li><a href="kiss.ui.Datatable.html">Datatable</a></li><li><a href="kiss.ui.Dialog.html">Dialog</a></li><li><a href="kiss.ui.Field.html">Field</a></li><li><a href="kiss.ui.Html.html">Html</a></li><li><a href="kiss.ui.Icon.html">Icon</a></li><li><a href="kiss.ui.IconPicker.html">IconPicker</a></li><li><a href="kiss.ui.Image.html">Image</a></li><li><a href="kiss.ui.Kanban.html">Kanban</a></li><li><a href="kiss.ui.Menu.html">Menu</a></li><li><a href="kiss.ui.Notification.html">Notification</a></li><li><a href="kiss.ui.Panel.html">Panel</a></li><li><a href="kiss.ui.Rating.html">Rating</a></li><li><a href="kiss.ui.Select.html">Select</a></li><li><a href="kiss.ui.Slider.html">Slider</a></li><li><a href="kiss.ui.Spacer.html">Spacer</a></li><li><a href="kiss.ui.Timeline.html">Timeline</a></li><li><a href="kiss.ui.Tip.html">Tip</a></li><li><a href="kiss.ux.AiImage.html">AiImage</a></li><li><a href="kiss.ux.AiTextarea.html">AiTextarea</a></li><li><a href="kiss.ux.CodeEditor.html">CodeEditor</a></li><li><a href="kiss.ux.Directory.html">Directory</a></li><li><a href="kiss.ux.Link.html">Link</a></li><li><a href="kiss.ux.Map.html">Map</a></li><li><a href="kiss.ux.MapField.html">MapField</a></li><li><a href="kiss.ux.QrCode.html">QrCode</a></li><li><a href="kiss.ux.RichTextField.html">RichTextField</a></li><li><a href="kiss.ux.WizardPanel.html">WizardPanel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createAttachment">createAttachment</a></li><li><a href="global.html#createBlock">createBlock</a></li><li><a href="global.html#createButton">createButton</a></li><li><a href="global.html#createCalendar">createCalendar</a></li><li><a href="global.html#createCheckbox">createCheckbox</a></li><li><a href="global.html#createCodeEditor">createCodeEditor</a></li><li><a href="global.html#createColorField">createColorField</a></li><li><a href="global.html#createColorPicker">createColorPicker</a></li><li><a href="global.html#createDatatable">createDatatable</a></li><li><a href="global.html#createDateField">createDateField</a></li><li><a href="global.html#createDialog">createDialog</a></li><li><a href="global.html#createField">createField</a></li><li><a href="global.html#createForm">createForm</a></li><li><a href="global.html#createHtml">createHtml</a></li><li><a href="global.html#createIconField">createIconField</a></li><li><a href="global.html#createIconPicker">createIconPicker</a></li><li><a href="global.html#createImage">createImage</a></li><li><a href="global.html#createKanban">createKanban</a></li><li><a href="global.html#createList">createList</a></li><li><a href="global.html#createMenu">createMenu</a></li><li><a href="global.html#createNotification">createNotification</a></li><li><a href="global.html#createNumberField">createNumberField</a></li><li><a href="global.html#createPanel">createPanel</a></li><li><a href="global.html#createPasswordField">createPasswordField</a></li><li><a href="global.html#createQRCode">createQRCode</a></li><li><a href="global.html#createRating">createRating</a></li><li><a href="global.html#createSelect">createSelect</a></li><li><a href="global.html#createSlider">createSlider</a></li><li><a href="global.html#createTextField">createTextField</a></li><li><a href="global.html#createTextareaField">createTextareaField</a></li><li><a href="global.html#createTimeline">createTimeline</a></li><li><a href="global.html#createTip">createTip</a></li><li><a href="global.html#createWizardPanel">createWizardPanel</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>client/core/db/online.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * 
 * ## Online database wrapper for KissJS server
 * 
 * Standard REST requests are performed for basic CRUD operations, except for:
 * - find(modelId, query)
 * - findById(modelId, ids, sort, sortSyntax)
 * - updateOneDeep(modelId, recordId, update)
 * - updateBulk(operations)
 * - deleteOne(modelId, recordId, sendToTrash)
 * - deleteMany(modelId, query, sendToTrash)
 * 
 * **Remember: these custom methods are design for KissJS server, and will not behave the same if used on another REST endpoint.**
 * 
 * The **find** method provides a rich and expressive way of querying the database with a **query** parameter.
 * The query can be an object with complex filters (multi-level AND / OR) and multi-field sorting, so, we need a way to send that (eventually big) object to the server.
 * As the HTTP GET method has some limitations about the amount of data that can be sent, KissJS uses a POST instead (despite it's a READ operation).
 * 
 * The **updateOneDeep** method performs a deep update of the record and its relationships.
 * This is the main method used to perform the updates of foreign records in a NoSQL environment.
 * 
 * The **updateBulk** method offers a convenient way to perform multiple updates in multiple collections at once.
 * The operations parameter is an array of operations, where each operation contains:
 * - the target modelId
 * - the target recordId
 * - the updates to apply to the target record
 * 
 * The **deleteOne** and **deleteMany** operations have an extra "sendToTrash" parameter which is useful to implement soft-deletion.
 * 
 * Below is a table of correspondance between the API and how it is converted to HTTP requests:
 *  
 * kiss.db.online | HTTP | HTTP body
 * --- | --- | ---
 * insertOne(modelId, record) | POST /modelId | record
 * insertMany(modelId, records) | POST /modelId | records
 * updateOne(modelId, recordId, update) | PATCH /modelId/recordId | update
 * updateOneDeep(modelId, recordId, update) | PATCH /modelId/recordId | {operation: "updateOneDeep", update} => update the record and its relationships
 * updateMany(modelId, query, update) | PATCH /modelId | query+update
 * updateBulk(operations) | PATCH /data | operations
 * findOne(modelId, recordId) | GET /modelId/recordId | &lt;none>
 * findById(modelId, ids, sort, sortSyntax) | POST /modelId | Array of ids
 * find(modelId) | GET /modelId | &lt;none>
 * find(modelId, query) | POST /modelId | query
 * deleteOne(modelId, recordId, sendToTrash) | DELETE /modelId/recordId | {sendToTrash: true/false}
 * deleteMany(modelId, query, sendToTrash) | POST /modelId | {operation: "delete", sendToTrash: true/false}
 * 
 * @namespace kiss.db.online
 * 
 */
kiss.db.online = {
    // Database endpoint, which defaults to the server root path url
    url: "",

    /**
     * Insert one record in a collection. See [db.insertOne](kiss.db.html#.insertOne)
     * 
     * @async
     * @param {string} modelId
     * @param {object} record - A single record
     * @returns {object} The server response
     */
    async insertOne(modelId, record) {
        log("kiss.db - online - insertOne - Model " + modelId, 0, record)

        const response = await kiss.ajax.request({
            url: "/" + modelId,
            method: "post",
            body: JSON.stringify(record)
        })

        // Broadcast
        const channel = "EVT_DB_INSERT:" + modelId.toUpperCase()
        kiss.pubsub.publish(channel, {
            channel,
            dbMode: "online",
            accountId: kiss.session.getCurrentAccountId(),
            userId: kiss.session.getUserId(),
            modelId,
            id: record.id,
            data: record
        })

        return response
    },

    /**
     * Insert many records in a collection. See [db.insertMany](kiss.db.html#.insertMany)
     * 
     * @async
     * @param {string} modelId
     * @param {object[]} records - An array of records [{...}, {...}] for bulk insert
     * @returns {object} The server response
     */
    async insertMany(modelId, records) {
        log("kiss.db - online - insertMany - Model" + modelId + " / " + records.length + " record(s)", 0, records)

        const response = await kiss.ajax.request({
            url: "/" + modelId,
            method: "post",
            body: JSON.stringify(records)
        })

        // Broadcast
        const channel = "EVT_DB_INSERT_MANY:" + modelId.toUpperCase()
        kiss.pubsub.publish(channel, {
            channel,
            dbMode: "online",
            accountId: kiss.session.getCurrentAccountId(),
            userId: kiss.session.getUserId(),
            modelId,
            data: records
        })

        return response
    },

    /**
     * Update a record in a collection. See [db.updateOne](kiss.db.html#.update)
     * 
     * @async
     * @param {string} modelId
     * @param {string} recordId
     * @param {string} update - Update to apply to the record. Ex: {firstName: "Bob"}
     * @returns {object} The server response
     */
    async updateOne(modelId, recordId, update) {
        log("kiss.db - online - updateOne - Model " + modelId + " / Record " + recordId, 0, update)

        const response = await kiss.ajax.request({
            url: "/" + modelId + "/" + recordId,
            method: "patch",
            body: JSON.stringify(update)
        })

        // Broadcast
        const channel = "EVT_DB_UPDATE:" + modelId.toUpperCase()
        kiss.pubsub.publish(channel, {
            channel,
            dbMode: "online",
            accountId: kiss.session.getCurrentAccountId(),
            userId: kiss.session.getUserId(),
            modelId,
            id: recordId,
            data: update
        })

        return response
    },

    /**
     * Update many records in a single collection. See [db.updateMany](kiss.db.html#.updateMany)
     * 
     * @async
     * @param {string} modelId
     * @param {object} query
     * @param {object} update
     * @returns {object} The server response
     * 
     * TODO: NOT TESTED YET
     */
    async updateMany(modelId, query, update) {
        log("kiss.db - online - updateMany - Model " + modelId, 0, update)

        const response = await kiss.ajax.request({
            url: "/" + modelId,
            method: "patch",
            body: JSON.stringify({
                query: query,
                update: update
            })
        })

        // Broadcast
        const channel = "EVT_DB_UPDATE_MANY:" + modelId.toUpperCase()
        kiss.pubsub.publish(channel, {
            channel,
            dbMode: "online",
            accountId: kiss.session.getCurrentAccountId(),
            userId: kiss.session.getUserId(),
            modelId,
            data: update
        })

        return response
    },

    /**
     * Update a single field of a record then propagate the triggered mutations to foreign records
     * 
     * IMPORTANT: this method does not broadcast to the active user because
     * all relationships computations are done server-side
     * 
     * @async
     * @param {string} modelId
     * @param {string} recordId
     * @param {string} [update] - If not specified, re-compute all the computed fields
     * @returns {boolean} true if the update is successful
     * 
     * @example
     * await kiss.db.updateOneDeep("company", "f07xF008d", {"name": "pickaform"})
     */
    async updateOneDeep(modelId, recordId, update) {
        log("kiss.db - online - updateOneDeep - Model " + modelId + " / Record " + recordId, 0, update)

        const response = await kiss.ajax.request({
            url: "/" + modelId + "/" + recordId,
            method: "patch",
            body: JSON.stringify({
                operation: "updateOneDeep",
                update
            })
        })

        // Broadcast
        const channel = "EVT_DB_UPDATE_ONE_DEEP:" + modelId.toUpperCase()
        kiss.pubsub.publish(channel, {
            channel,
            dbMode: "online",
            accountId: kiss.session.getCurrentAccountId(),
            userId: kiss.session.getUserId(),
            modelId,
            id: recordId,
            data: update
        })

        return response
    },

    /**
     * Update the 2 records connected by a link
     * 
     * @param {object} link 
     * @returns The transaction result
     */
    async updateLink(link) {
        log("kiss.db - online - updateLink: ", 0, link)

        const response = await kiss.ajax.request({
            url: "/updateLink",
            method: "post",
            body: JSON.stringify(link)
        })

        return response
    },

    /**
     * Update multiple records in multiple collections. See [db.updateBulk](kiss.db.html#.updateBulk)
     * 
     * @async
     * @param {object[]} operations - The list of updates to perform
     * @returns {object} The server response
     */
    async updateBulk(operations) {
        log("kiss.db - online - updateBulk", 0, operations)

        const response = await kiss.ajax.request({
            url: "/bulk",
            method: "patch",
            body: JSON.stringify(operations)
        })

        // Broadcast
        const channel = "EVT_DB_UPDATE_BULK"
        kiss.pubsub.publish(channel, {
            channel,
            dbMode: "online",
            accountId: kiss.session.getCurrentAccountId(),
            userId: kiss.session.getUserId(),
            data: operations
        })

        return response
    },

    /**
     * Find a single record by id. See [db.findOne](kiss.db.html#.findOne)
     * 
     * @async
     * @param {string} modelId 
     * @param {string} recordId
     * @returns {object} The server response
     */
    async findOne(modelId, recordId) {
        log("kiss.db - online - findOne - Model " + modelId + " / Record " + recordId)

        return await kiss.ajax.request({
            url: "/" + modelId + "/" + recordId,
            method: "get"
        })
    },

    /**
     * Find multiple records by id
     * 
     * @async
     * @param {string} modelId 
     * @param {string[]} ids - ids of the records to retrieve
     * @param {object[]|object} [sort] - Sort options, as a normalized array or a Mongo object. Normalized example: [{fieldA: "asc"}, {fieldB: "desc"}]. Mongo example: {fieldA: 1, fieldB: -1}
     * @param {string} [sortSyntax] - Sort syntax: "nomalized" | "mongo". Default is normalized
     * @returns {object[]} The found records
     */
     async findById(modelId, ids, sort = [], sortSyntax = "normalized") {
        log("kiss.db - online - findById - Model " + modelId + " / Records: " + ids.join())

        const search = {
            operation: "search",
            ids,
            sort,
            sortSyntax
        }

        return await kiss.ajax.request({
            url: "/" + modelId,
            method: "post",
            body: JSON.stringify(search)
        })
    },

    /**
     * Find documents in a collection. See [db.find](kiss.db.html#.find)
     * 
     * Important:
     * - without query params, it uses standard GET
     * - with query params, the only way is to "POST" the request to the server
     * In effet, the HTTP GET query parameters are limited in size, which is blocking to handle complex queries.
     * 
     * @async
     * @param {string} modelId
     * @param {object} [query] - Optional query object
     * @returns {object[]} An array containing the records data
     */
    async find(modelId, query) {
        log("kiss.db - online - find - Model " + modelId + " / Query:", 0, query)

        // No query: we return all records with a find()
        if (!query) {
            return await kiss.ajax.request({
                url: "/" + modelId,
                method: "get"
            })
        }

        // Sanitize the query
        const search = {
            operation: "search",
            filter: query.filter || {},
            filterSyntax: query.filterSyntax || "normalized",
            sort: query.sort || {},
            sortSyntax: query.sortSyntax || "normalized",
            group: query.group || [],
            projection: query.projection || {},
            skip: query.skip,
            limit: query.limit,
            groupUnwind: query.groupUnwind
        }

        return await kiss.ajax.request({
            url: "/" + modelId,
            method: "post", // Only way to post the query object properly
            body: JSON.stringify(search)
        })
    },

    /**
     * Delete an element from a collection. See [db.delete](kiss.db.html#.delete)
     * 
     * @async
     * @param {string} modelId
     * @param {string} recordId
     * @param {boolean} [sendToTrash] - If true, keeps the original record in a "trash" collection
     * @returns {boolean}
     */
    async deleteOne(modelId, recordId, sendToTrash) {
        log("kiss.db - online - deleteOne - Model " + modelId + " / Record " + recordId)

        const response = await kiss.ajax.request({
            url: "/" + modelId + "/" + recordId,
            method: "delete",
            body: JSON.stringify({
                sendToTrash: !!sendToTrash
            })
        })

        // Broadcast
        const channel = "EVT_DB_DELETE:" + modelId.toUpperCase()
        kiss.pubsub.publish(channel, {
            channel,
            dbMode: "online",
            accountId: kiss.session.getCurrentAccountId(),
            userId: kiss.session.getUserId(),
            modelId,
            id: recordId
        })

        return !!response.success
    },

    /**
     * Delete many records from a collection
     * 
     * Note: REST doesn't have any standard way to perform a bulk delete.
     * For this, we use a custom POST operation, as suggested in the Google API Design Guide
     * 
     * @param {string} modelId 
     * @param {object} query
     * @param {boolean} [sendToTrash] - If true, keeps the original record in a "trash" collection
     * @returns {object} The server response
     */
    async deleteMany(modelId, query, sendToTrash) {
        log("kiss.db - online - deleteMany - Model " + modelId, 0, query)

        const params = {
            operation: "delete",
            filter: query || {},
            sendToTrash: !!sendToTrash
        }

        const response = await kiss.ajax.request({
            url: "/" + modelId,
            method: "post", // Only way to post the query object properly
            body: JSON.stringify(params),
            showLoading: true
        })

        // Broadcast
        const channel = "EVT_DB_DELETE_MANY:" + modelId.toUpperCase()
        kiss.pubsub.publish(channel, {
            channel,
            dbMode: "online",
            accountId: kiss.session.getCurrentAccountId(),
            userId: kiss.session.getUserId(),
            modelId,
            data: query
        })

        return response
    },

    /**
     * Count the number of records that match a query
     * 
     * @async
     * @param {string} modelId
     * @param {object} query - Use same query format as for find() method
     * @returns {number} The number of records
     */
    count(modelId, query) {
        log("kiss.db - online - count - Model " + modelId, 0, query)

        // TODO
        return 42
    }
}

;</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
